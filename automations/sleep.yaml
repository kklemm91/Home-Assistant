- id: he_sleeps
  alias: Last to bed
  trigger:
  - platform: state
    entity_id: group.all_lights
    to: 'off'
  - platform: numeric_state
    entity_id: sensor.fractal_cpu_idle
    above: 91
    for:
      hours: 1
  condition:
  - condition: time
    after: '22:00:00'
    before: '03:00:00'
  - condition: state
    entity_id: sensor.his_status
    state: Home
  action:
  - service: input_select.select_option
    data:
      entity_id: input_select.his_status_dropdown
      option: Sleeping

- id: she_sleeps
  alias: First to bed
  trigger:
  - platform: state
    entity_id: light.bedroom
    to: 'off'
  condition:
  - condition: time
    after: '21:00:00'
    before: '03:00:00'
  - condition: state
    entity_id: sensor.her_status
    state: Home
  action:
  - service: input_select.select_option
    data:
      entity_id: input_select.her_status_dropdown
      option: Sleeping
  - service: light.turn_off
    entity_id: light.office

- id: handle_sleep
  alias: Handle sleep light control
  trigger:
  - platform: state
    entity_id: sensor.his_status
    to: Sleeping
  - platform: state
    entity_id: sensor.her_status
    to: Sleeping
  action:
  - service: scene.turn_on
    data_template:
      entity_id: >
        {% if states.sensor.his_status.state == states.sensor.her_status.state %}
          scene.all_off
        {% endif %}